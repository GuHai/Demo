package com.yskj.service;import com.yskj.dao.SettlementpersonDao;import com.yskj.exception.IJobException;import com.yskj.models.Account;import com.yskj.models.Position;import com.yskj.models.QueryParam;import com.yskj.models.Settlementperson;import com.yskj.service.base.AbstractService;import com.yskj.utils.IJobSecurityUtils;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.util.List;import java.util.Map;@Servicepublic class SettlementpersonService extends AbstractService {	@Autowired    private SettlementpersonDao settlementpersonDao;	@Autowired	private AccountService accountService;	public SettlementpersonService() {		super();	}	@Override	public SettlementpersonDao getDao() {		return this.settlementpersonDao;	}	public Double getSettlementMoney(String id){		return settlementpersonDao.getSettlementMoney(id);	}	public Map getSettlementInfo(QueryParam queryParam){		Map map =  getDao().getSettlementInfo(queryParam);		if(map.get("confirmed")==null){			map.put("confirmed",0);		}		if(map.get("totalmoney")==null){			map.put("totalmoney",0);		}		return map;	}	public Settlementperson mapOne(QueryParam queryParam){		return getDao().mapOne(queryParam);	}	public List<Position> 	getUserPositionWaitSettlementInfoAt(QueryParam queryParam){		return settlementpersonDao.getUserPositionWaitSettlementInfoAt(queryParam);	}	public List<Settlementperson> getUserSettlementpersonInfo(QueryParam queryParam){		return settlementpersonDao.getUserSettlementpersonInfo(queryParam);	}	public List<Settlementperson> getSettlementperson(QueryParam queryParam){		return settlementpersonDao.getSettlementperson(queryParam);	}	public Settlementperson getCurrSettlementInfo(QueryParam queryParam){		return settlementpersonDao.getCurrSettlementInfo(queryParam);	}	//确认薪资，修改状态，然后记录到我的账户里面去	@Transactional(rollbackFor=Exception.class)	public void confirmAll(List<Settlementperson> settlementpersons)throws Exception{		List<String> ids = this.findIds(settlementpersons);		QueryParam queryParam = new QueryParam();		queryParam.in("id",ids);		List<Settlementperson> list = this.getDao().mapList(queryParam);		for(Settlementperson settlementperson : list){			settlementperson.setState(true);			//检查是不是已经存在了			queryParam.clear();			queryParam.put("userID",IJobSecurityUtils.getLoginUserId());			queryParam.put("orderNo",settlementperson.getId());			Account one = accountService.one(queryParam);			if(one==null){				Account account = new Account();				account.setIsPass(Boolean.TRUE);				account.setIsIn(Boolean.TRUE);				account.setUserID(IJobSecurityUtils.getLoginUserId());				account.setMoney(settlementperson.getSettlementMoney());				account.setOrderNo(settlementperson.getId());				account.setType(2);				accountService.add(account);			}else{				throw new IJobException("已经确认过眼神了，不能太贪心了啊");			}		}		this.persistenceList(list);	}}